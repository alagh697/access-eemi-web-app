---
- name: Créer le dossier de l'application
  ansible.builtin.file:
    path: "{{ app_dir }}"
    state: directory
    owner: ansible
    group: ansible
    mode: "0755"
  become: yes

- name: Synchroniser le projet Next.js (code + build + node_modules) vers le serveur
  ansible.posix.synchronize:
    src: "{{ project_src }}/"
    dest: "{{ app_dir }}/"
    delete: yes
    rsync_opts:
      - "--exclude=.git"
      - "--exclude=.github"
      - "--exclude=infra"
      - "--exclude=.vscode"
      - "--exclude=.idea"

- name: Vérifier que package.json existe bien sur le serveur
  ansible.builtin.stat:
    path: "{{ app_dir }}/package.json"
  register: package_json_check

- name: Stop si package.json est introuvable
  ansible.builtin.fail:
    msg: "package.json n'a pas été trouvé dans {{ app_dir }} — le projet n'a pas été bien synchronisé."
  when: not package_json_check.stat.exists
